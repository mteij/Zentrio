name: Build Tauri App

on:
  repository_dispatch:
    types: [tauri-build]
  workflow_call:
    inputs:
      version:
        description: "Version to build (optional, defaults to package.json)"
        required: false
        type: string
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (optional, defaults to package.json)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  # First, ensure the release exists before any builds start
  create-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag_name: ${{ steps.version.outputs.tag_name }}
      release_id: ${{ steps.get_release_id.outputs.release_id }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Get version
        id: version
        run: |
          if [ -n "${{ github.event.client_payload.version }}" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          elif [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(node -e "console.log(require('./app/package.json').version)")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=v$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"

      - name: Ensure release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"

          # Check if release exists
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "âœ… Release $TAG already exists"
          else
            echo "âŒ Release $TAG does not exist."
            echo "This workflow should be triggered by release.yml which creates the release first."
            echo "If running manually, ensure the release tag v$VERSION exists."
            exit 1
          fi

      - name: Set pre-release flag for 0.x.x versions
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          MAJOR=$(echo "$VERSION" | cut -d. -f1)
          if [ "$MAJOR" = "0" ]; then
            echo "ðŸ“¦ Version $VERSION is 0.x.x â€” ensuring release is marked as pre-release"
            gh release edit "v$VERSION" --prerelease
          fi

      - name: Get Release ID
        id: get_release_id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ steps.version.outputs.version }}"
          RELEASE_ID=$(gh release view "$TAG" --json databaseId -q .databaseId)
          echo "release_id=$RELEASE_ID" >> $GITHUB_OUTPUT
          echo "Got Release ID: $RELEASE_ID"

  build-tauri:
    needs: [create-release]
    strategy:
      fail-fast: false
      matrix:
        include:
          # iOS build temporarily disabled - requires Apple Developer account with code signing
          # To enable: Set up APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD, APPLE_PROVISIONING_PROFILE secrets
          # - platform: "macos-latest"
          #   args: "--target aarch64-apple-ios"
          #   name: "ios"
          - platform: "macos-latest" # Apple Silicon runner for macOS
            args: "--target aarch64-apple-darwin"
            name: "macos"
          - platform: "ubuntu-22.04" # for Linux
            args: ""
            name: "linux"
          - platform: "windows-latest" # for Windows
            args: ""
            name: "windows"
          - platform: "ubuntu-22.04" # for Android
            args: "--target aarch64-linux-android"
            name: "android"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ needs.create-release.outputs.tag_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin' || matrix.name == 'android' && 'aarch64-linux-android' || '' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./app/src-tauri -> target"

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        # Dependencies per Tauri v2 docs + additional tools for linuxdeploy
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libayatana-appindicator3-dev librsvg2-dev libxdo-dev libssl-dev libfuse2 file wget curl patchelf

      - name: Setup Java (Android only)
        if: matrix.name == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Android SDK (Android only)
        if: matrix.name == 'android'
        uses: android-actions/setup-android@v3

      - name: Install NDK (Android only)
        if: matrix.name == 'android'
        run: sdkmanager "ndk;26.1.10909125"

      - name: Configure Android NDK environment
        if: matrix.name == 'android'
        run: |
          ANDROID_NDK_HOME="$ANDROID_HOME/ndk/26.1.10909125"
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"

          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "$NDK_TOOLCHAIN" >> $GITHUB_PATH

          # Set the compilers directly to the specific API level binaries
          echo "CC_aarch64_linux_android=$NDK_TOOLCHAIN/aarch64-linux-android24-clang" >> $GITHUB_ENV
          echo "CXX_aarch64_linux_android=$NDK_TOOLCHAIN/aarch64-linux-android24-clang++" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=$NDK_TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$NDK_TOOLCHAIN/aarch64-linux-android24-clang" >> $GITHUB_ENV

      - name: Setup Gradle cache (Android only)
        if: matrix.name == 'android'
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Install frontend dependencies
        working-directory: ./app
        run: bun install

      - name: Sync versions
        working-directory: ./app
        run: bun run sync

      # Server Binary Builds
      - name: Build Server Binary (Linux host)
        if: matrix.platform == 'ubuntu-22.04'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-linux-x64 --outfile src-tauri/bin/zentrio-server-x86_64-unknown-linux-gnu

      - name: Build Server Binary (Windows)
        if: matrix.name == 'windows'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-windows-x64 --outfile src-tauri/bin/zentrio-server-x86_64-pc-windows-msvc.exe

      - name: Build Server Binary (macOS)
        if: matrix.name == 'macos'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-darwin-arm64 --outfile src-tauri/bin/zentrio-server-aarch64-apple-darwin

      # Desktop Build (Linux, Windows, macOS Desktop)
      - name: Build Tauri App (Desktop)
        if: matrix.name != 'android' && matrix.name != 'ios'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          NO_STRIP: true
          APPIMAGE_EXTRACT_AND_RUN: 1
        with:
          projectPath: ./app
          tagName: ${{ needs.create-release.outputs.tag_name }}
          releaseId: ${{ needs.create-release.outputs.release_id }}
          args: ${{ matrix.args }}

      # Android Build
      - name: Build Android
        if: matrix.name == 'android'
        working-directory: ./app
        env:
          NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
        run: |
          # Decode keystore from base64
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks
          KEYSTORE_PATH="$(pwd)/keystore.jks"

          # Initialize Android project (creates fresh gen/android/ with default icons)
          rm -rf src-tauri/gen/android
          bun tauri android init

          # Generate icons - MUST run after android init to overwrite default icons
          # The tauri icon command generates icons for all platforms including Android mipmap
          echo "ðŸ“± Generating app icons from src-tauri/icons/icon.png..."
          bun tauri icon src-tauri/icons/icon.png

          # Set dark background color for adaptive icon (instead of default white)
          echo "ðŸŽ¨ Setting dark icon background color..."
          COLORS_FILE="src-tauri/gen/android/app/src/main/res/values/colors.xml"
          if [ -f "$COLORS_FILE" ]; then
            # Replace the ic_launcher_background color with dark gray
            sed -i 's/#FFFFFF/#121212/g' "$COLORS_FILE"
            echo "âœ… Updated icon background to dark (#121212)"
            cat "$COLORS_FILE"
          fi

          # Verify Android icons were generated correctly
          echo "âœ… Verifying Android icon resources were generated..."
          if [ -d "src-tauri/gen/android/app/src/main/res/mipmap-hdpi" ]; then
            echo "Found mipmap directories:"
            ls -la src-tauri/gen/android/app/src/main/res/mipmap-*/
          else
            echo "âš ï¸ Warning: Android mipmap directories not found!"
          fi


          # Configure signing via gradle.properties (not CLI flags)
          GRADLE_PROPS="src-tauri/gen/android/gradle.properties"
          echo "" >> "$GRADLE_PROPS"
          echo "# Signing configuration" >> "$GRADLE_PROPS"
          echo "android.injected.signing.store.file=$KEYSTORE_PATH" >> "$GRADLE_PROPS"
          echo "android.injected.signing.store.password=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" >> "$GRADLE_PROPS"
          echo "android.injected.signing.key.alias=${{ secrets.ANDROID_KEY_ALIAS }}" >> "$GRADLE_PROPS"
          echo "android.injected.signing.key.password=${{ secrets.ANDROID_KEY_PASSWORD }}" >> "$GRADLE_PROPS"

          # Build Universal APK (all architectures)
          bun tauri android build --apk true

          # Build ARM64-only APK (smaller, for modern devices)
          bun tauri android build --apk true --target aarch64

      - name: Rename Android APKs
        if: matrix.name == 'android'
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"

          # Rename Universal APK
          UNIVERSAL_DIR="app/src-tauri/gen/android/app/build/outputs/apk/universal/release"
          if [ -f "$UNIVERSAL_DIR/app-universal-release.apk" ]; then
            mv "$UNIVERSAL_DIR/app-universal-release.apk" "$UNIVERSAL_DIR/Zentrio_${VERSION}_android-universal.apk"
            echo "âœ… Renamed Universal APK to Zentrio_${VERSION}_android-universal.apk"
          fi

          # Rename ARM64 APK
          ARM64_DIR="app/src-tauri/gen/android/app/build/outputs/apk/arm64/release"
          if [ -f "$ARM64_DIR/app-arm64-release.apk" ]; then
            mv "$ARM64_DIR/app-arm64-release.apk" "$ARM64_DIR/Zentrio_${VERSION}_android-arm64.apk"
            echo "âœ… Renamed ARM64 APK to Zentrio_${VERSION}_android-arm64.apk"
          fi

          # List all APKs for debugging
          echo "ðŸ“¦ Available APKs:"
          find app/src-tauri/gen/android -name "*.apk" -type f

      - name: Upload Android Artifacts to Release
        if: matrix.name == 'android'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: |
            app/src-tauri/gen/android/app/build/outputs/apk/universal/release/Zentrio_*.apk
            app/src-tauri/gen/android/app/build/outputs/apk/arm64/release/Zentrio_*.apk

      # iOS Build
      - name: Build iOS
        if: matrix.name == 'ios'
        working-directory: ./app
        run: |
          bun tauri ios init

          # Aggressively patch generated project to disable all signing
          PBXPROJ="src-tauri/gen/apple/zentrio.xcodeproj/project.pbxproj"

          # Force Manual signing style
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' "$PBXPROJ"

          # Set DEVELOPMENT_TEAM to empty string for all occurrences
          sed -i '' 's/DEVELOPMENT_TEAM = "[^"]*";/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"

          # Set CODE_SIGNING_ALLOWED to NO
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES;/CODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"

          # Add CODE_SIGNING_ALLOWED = NO if not present (append to build settings)
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Manual; CODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"

          # Build with all signing disabled
          bun tauri ios build --export-method debugging -- \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Upload iOS Artifacts to Release
        if: matrix.name == 'ios'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: |
            app/src-tauri/gen/apple/build/Release-iphoneos/*.app
            app/src-tauri/gen/apple/build/Release-iphoneos/*.ipa
