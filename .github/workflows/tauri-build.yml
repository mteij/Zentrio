name: Build Tauri App

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-tauri:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: "macos-13" # for iOS (more stable than macos-latest)
            args: "--target aarch64-apple-ios"
            name: "ios"
          - platform: "macos-13" # for macOS (more stable for DMG bundling)
            args: "--target aarch64-apple-darwin"
            name: "macos"
          - platform: "ubuntu-22.04" # for Linux
            args: ""
            name: "linux"
          - platform: "windows-latest" # for Windows
            args: ""
            name: "windows"
          - platform: "ubuntu-22.04" # for Android
            args: "--target aarch64-linux-android"
            name: "android"

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # Those targets are only used on macos runners so it's in an `if` to slightly speed up windows and linux builds.
          targets: ${{ matrix.platform == 'macos-13' && 'aarch64-apple-ios,x86_64-apple-ios,aarch64-apple-darwin,x86_64-apple-darwin' || matrix.name == 'android' && 'aarch64-linux-android' || '' }}

      - name: Install dependencies (ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        # Added wget and curl for linuxdeploy
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libayatana-appindicator3-dev librsvg2-dev libfuse2 file wget curl patchelf

      - name: Setup Java (Android only)
        if: matrix.name == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Android SDK (Android only)
        if: matrix.name == 'android'
        uses: android-actions/setup-android@v3

      - name: Install NDK (Android only)
        if: matrix.name == 'android'
        run: sdkmanager "ndk;26.1.10909125"

      - name: Configure Android NDK environment
        if: matrix.name == 'android'
        run: |
          ANDROID_NDK_HOME="$ANDROID_HOME/ndk/26.1.10909125"
          NDK_TOOLCHAIN="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin"

          echo "ANDROID_NDK_HOME=$ANDROID_NDK_HOME" >> $GITHUB_ENV
          echo "$NDK_TOOLCHAIN" >> $GITHUB_PATH

          # Set the compilers directly to the specific API level binaries
          echo "CC_aarch64_linux_android=$NDK_TOOLCHAIN/aarch64-linux-android24-clang" >> $GITHUB_ENV
          echo "CXX_aarch64_linux_android=$NDK_TOOLCHAIN/aarch64-linux-android24-clang++" >> $GITHUB_ENV
          echo "AR_aarch64_linux_android=$NDK_TOOLCHAIN/llvm-ar" >> $GITHUB_ENV
          echo "CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER=$NDK_TOOLCHAIN/aarch64-linux-android24-clang" >> $GITHUB_ENV

      - name: Install frontend dependencies
        run: cd app && npm install # Using npm install instead of bun for broader compatibility in CI

      - name: Get version
        run: |
          echo "VERSION=$(node -e "console.log(require('./app/package.json').version)")" >> $GITHUB_ENV

      # Server Binary Builds
      - name: Build Server Binary (Linux)
        if: matrix.name == 'linux'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-linux-x64 --outfile src-tauri/bin/zentrio-server-x86_64-unknown-linux-gnu

      - name: Build Server Binary (Windows)
        if: matrix.name == 'windows'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-windows-x64 --outfile src-tauri/bin/zentrio-server-x86_64-pc-windows-msvc.exe

      - name: Build Server Binary (macOS)
        if: matrix.name == 'macos'
        working-directory: ./app
        run: |
          bun build src/index.ts --compile --target bun-darwin-arm64 --outfile src-tauri/bin/zentrio-server-aarch64-apple-darwin

      # Desktop Build (Linux, Windows, macOS Desktop)
      - name: Build Tauri App (Desktop)
        if: matrix.name != 'android' && matrix.name != 'ios'
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NO_STRIP: true
          APPIMAGE_EXTRACT_AND_RUN: 1
        with:
          projectPath: ./app
          tagName: app-v__VERSION__
          releaseName: "App v__VERSION__"
          releaseBody: "See the assets to download this version and install."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}

      # Android Build
      - name: Build Android
        if: matrix.name == 'android'
        working-directory: ./app
        env:
          NDK_HOME: ${{ env.ANDROID_NDK_HOME }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          # Decode keystore from base64
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 -d > keystore.jks

          bun tauri android init
          bun tauri android build --apk true -- \
            -Pandroid.injected.signing.store.file=$(pwd)/keystore.jks \
            -Pandroid.injected.signing.store.password=$ANDROID_KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$ANDROID_KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$ANDROID_KEY_PASSWORD

      - name: Upload Android Artifacts to Release
        if: matrix.name == 'android'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: app-v${{ env.VERSION }}
          # We need to ensure the release exists or is created.
          # tauri-action creates it. If Android runs faster, this might fail?
          # Or softprops creates it if missing? It does.
          draft: true
          files: |
            app/src-tauri/gen/android/app/build/outputs/apk/**/*.apk

      # iOS Build
      - name: Build iOS
        if: matrix.name == 'ios'
        working-directory: ./app
        run: |
          bun tauri ios init

          # Aggressively patch generated project to disable all signing
          PBXPROJ="src-tauri/gen/apple/zentrio.xcodeproj/project.pbxproj"

          # Force Manual signing style
          sed -i '' 's/ProvisioningStyle = Automatic;/ProvisioningStyle = Manual;/g' "$PBXPROJ"

          # Set DEVELOPMENT_TEAM to empty string for all occurrences
          sed -i '' 's/DEVELOPMENT_TEAM = "[^"]*";/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"
          sed -i '' 's/DEVELOPMENT_TEAM = [^;]*;/DEVELOPMENT_TEAM = "";/g' "$PBXPROJ"

          # Set CODE_SIGNING_ALLOWED to NO
          sed -i '' 's/CODE_SIGNING_ALLOWED = YES;/CODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"

          # Add CODE_SIGNING_ALLOWED = NO if not present (append to build settings)
          sed -i '' 's/CODE_SIGN_STYLE = Manual;/CODE_SIGN_STYLE = Manual; CODE_SIGNING_ALLOWED = NO;/g' "$PBXPROJ"

          # Build with all signing disabled
          bun tauri ios build --export-method debugging -- \
            CODE_SIGN_STYLE="Manual" \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGN_IDENTITY="" \
            DEVELOPMENT_TEAM="" \
            PROVISIONING_PROFILE_SPECIFIER="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_ENTITLEMENTS=""

      - name: Upload iOS Artifacts to Release
        if: matrix.name == 'ios'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: app-v${{ env.VERSION }}
          draft: true
          files: |
            app/src-tauri/gen/apple/build/Release-iphoneos/*.app
            app/src-tauri/gen/apple/build/Release-iphoneos/*.ipa
