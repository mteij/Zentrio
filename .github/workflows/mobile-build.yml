name: Build Mobile Apps

on:
  workflow_run:
    workflows: ["Build and Push Docker Image"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  contents: read
  actions: write

env:
  NODE_VERSION: 20
  BUN_VERSION: latest

jobs:
  build-android:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Set JAVA_HOME
        run: echo "JAVA_HOME=$JAVA_HOME" >> $GITHUB_ENV

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -e "console.log(require('./app/package.json').version)")
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Cancel if mobile assets for this version already exist
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          echo "Checking if mobile assets already exist for v$VERSION"
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            # Check for the main release APK as marker that mobile build is done
            if gh release view "v$VERSION" --json assets -q '.assets[].name' | grep -q "Zentrio-v$VERSION.apk"; then
              echo "Mobile assets for v$VERSION already exist. Cancelling this workflow run."
              if gh run cancel "$GITHUB_RUN_ID"; then
                gh run watch "$GITHUB_RUN_ID"
              else
                echo "Cancel not available in this context (likely due to token permissions). Continuing without failing the job."
              fi
            else
              echo "Release v$VERSION exists but no mobile assets found yet. Continuing."
            fi
          else
            echo "Release v$VERSION does not exist yet or cannot be fetched; continuing."
          fi

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: app/node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('app/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        working-directory: ./app
        run: bun install --frozen-lockfile

      - name: Build web assets
        working-directory: ./app
        run: bun run build

      - name: Sync Capacitor
        working-directory: ./app
        run: bunx cap sync android

      - name: Make gradlew executable
        working-directory: ./app/android
        run: chmod +x ./gradlew

      - name: Clean Gradle cache
        working-directory: ./app/android
        run: |
          rm -rf ~/.gradle/caches/
          rm -rf ~/.gradle/daemon/
          ./gradlew clean

      - name: Configure Android keystore for signing
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -z "$ANDROID_KEYSTORE_BASE64" ]; then
            echo "ANDROID_KEYSTORE_BASE64 not set; release APK/AAB will be unsigned."
            exit 0
          fi
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/android/app/release.keystore
          echo "ANDROID_KEYSTORE_PATH=$GITHUB_WORKSPACE/app/android/app/release.keystore" >> $GITHUB_ENV
          echo "ANDROID_KEYSTORE_PASSWORD=$ANDROID_KEYSTORE_PASSWORD" >> $GITHUB_ENV
          echo "ANDROID_KEY_ALIAS=$ANDROID_KEY_ALIAS" >> $GITHUB_ENV
          echo "ANDROID_KEY_PASSWORD=$ANDROID_KEY_PASSWORD" >> $GITHUB_ENV

      - name: Build Android Debug APK
        working-directory: ./app/android
        run: ./gradlew assembleDebug

      - name: Build Android Release APK
        working-directory: ./app/android
        run: ./gradlew assembleRelease

      - name: Build Android Release Bundle (AAB)
        working-directory: ./app/android
        run: ./gradlew bundleRelease

      - name: Find and list APK files
        working-directory: ./app/android
        run: |
          echo "Finding APK files..."
          find . -name "*.apk" -type f
          echo "Finding AAB files..."
          find . -name "*.aab" -type f

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-builds
          path: |
            app/android/app/build/outputs/apk/debug/*.apk
            app/android/app/build/outputs/apk/release/*.apk
            app/android/app/build/outputs/bundle/release/*.aab
          retention-days: 30

  # iOS build disabled - temporarily disabled
  # build-ios:
  #   runs-on: macos-latest
  #   if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
  #
  #   steps:
  #     - name: Checkout repository
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v1
  #       with:
  #         bun-version: ${{ env.BUN_VERSION }}
  #
  #     - name: Get version
  #       id: version
  #       run: |
  #         if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
  #           echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
  #         else
  #           VERSION=$(node -e "console.log(require('./app/package.json').version)")
  #           echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
  #         fi
  #
  #     - name: Cache node modules
  #       uses: actions/cache@v4
  #       with:
  #         path: app/node_modules
  #         key: ${{ runner.os }}-bun-${{ hashFiles('app/bun.lock') }}
  #         restore-keys: |
  #           ${{ runner.os }}-bun-
  #
  #     - name: Install dependencies
  #       working-directory: ./app
  #       run: bun install --frozen-lockfile
  #
  #     - name: Install CocoaPods
  #       working-directory: ./app/ios/App
  #       run: pod install
  #
  #     - name: Build web assets
  #       working-directory: ./app
  #       run: bun run build
  #
  #     - name: Sync Capacitor
  #       working-directory: ./app
  #       run: bunx cap sync ios
  #
  #     - name: Build iOS Archive
  #       working-directory: ./app/ios/App
  #       run: |
  #         xcodebuild -workspace App.xcworkspace \
  #           -scheme App \
  #           -configuration Release \
  #           -destination generic/platform=iOS \
  #           -archivePath $PWD/build/App.xcarchive \
  #           CODE_SIGN_IDENTITY="" \
  #           CODE_SIGNING_REQUIRED=NO \
  #           archive
  #
  #     - name: Create ExportOptions.plist
  #       working-directory: ./app/ios/App
  #       run: |
  #         cat > ExportOptions.plist << 'EOF'
  #         <?xml version="1.0" encoding="UTF-8"?>
  #         <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  #         <plist version="1.0">
  #         <dict>
  #             <key>method</key>
  #             <string>development</string>
  #             <key>uploadBitcode</key>
  #             <false/>
  #             <key>uploadSymbols</key>
  #             <true/>
  #             <key>compileBitcode</key>
  #             <false/>
  #             <key>signingStyle</key>
  #             <string>automatic</string>
  #             <key>destination</key>
  #             <string>export</string>
  #             <key>stripSwiftSymbols</key>
  #             <true/>
  #             <key>thinning</key>
  #             <string><none></string>
  #         </dict>
  #         </plist>
  #         EOF
  #
  #     - name: Export IPA
  #       working-directory: ./app/ios/App
  #       run: |
  #         xcodebuild -exportArchive \
  #           -archivePath $PWD/build/App.xcarchive \
  #           -exportPath $PWD/build \
  #           -exportOptionsPlist ExportOptions.plist
  #
  #     - name: Upload iOS artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-builds
  #         path: app/ios/App/build/*.ipa
  #         retention-days: 30

  upload-to-release:
    runs-on: ubuntu-latest
    needs: [build-android]
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=$(node -e "console.log(require('./app/package.json').version)")
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Download Android artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-builds
          path: ./android-artifacts

      - name: Create release directory
        run: |
          mkdir -p release-assets
          echo "Checking Android artifacts:"
          ls -la android-artifacts/ || echo "No android-artifacts directory"
          # Copy all APKs/AABs into release-assets
          find android-artifacts/ -name "*.apk" -exec cp {} release-assets/ \; 2>/dev/null || echo "No APK files found"
          find android-artifacts/ -name "*.aab" -exec cp {} release-assets/ \; 2>/dev/null || echo "No AAB files found"

          # Rename the main release APK to a stable name like Zentrio-v(version).apk
          RELEASE_APK=$(find release-assets -maxdepth 1 -type f -name "*release*.apk" | head -1 || true)
          if [ -n "$RELEASE_APK" ]; then
            NEW_NAME="Zentrio-v${{ steps.version.outputs.VERSION }}.apk"
            echo "Renaming release APK $RELEASE_APK to release-assets/$NEW_NAME"
            mv "$RELEASE_APK" "release-assets/$NEW_NAME"
          else
            echo "No release APK found to rename"
          fi

      - name: List release assets
        run: |
          echo "Release assets directory:"
          ls -la release-assets/ || echo "No release-assets directory"
          echo "File details:"
          file release-assets/* || echo "No files to analyze"

      - name: Upload assets to GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Attempting to upload files to release v${{ steps.version.outputs.VERSION }}"
          if [ -d "release-assets" ] && [ "$(ls -A release-assets)" ]; then
            for file in release-assets/*; do
              if [ -f "$file" ]; then
                echo "Uploading $file to release v${{ steps.version.outputs.VERSION }}"
                gh release upload "v${{ steps.version.outputs.VERSION }}" "$file" --clobber || echo "Failed to upload $file"
              fi
            done
          else
            echo "No files to upload - release-assets directory is empty or doesn't exist"
          fi

      - name: Update release notes with mobile download links
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Get current release notes
          gh release view "v${{ steps.version.outputs.VERSION }}" --json body -q '.body' > current-notes.md
          
          # Create mobile download section
          cat > mobile-section.md << EOF
          
          ## ðŸ“± Mobile Downloads
          
          EOF
          
          # Add Android links if files exist
          if ls release-assets/*debug*.apk 1> /dev/null 2>&1; then
            DEBUG_APK_FILE=$(ls release-assets/*debug*.apk 2>/dev/null | head -1 | xargs -n1 basename)
            echo "### Android" >> mobile-section.md
            echo "- **APK (Debug)**: [Download Debug APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/$DEBUG_APK_FILE)" >> mobile-section.md
          fi
          
          RELEASE_APK_FILE="Zentrio-v${{ steps.version.outputs.VERSION }}.apk"
          if [ -f "release-assets/$RELEASE_APK_FILE" ]; then
            if ! grep -q "### Android" mobile-section.md; then
              echo "### Android" >> mobile-section.md
            fi
            echo "- **APK (Release)**: [Download Release APK](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/$RELEASE_APK_FILE)" >> mobile-section.md
          fi
          
          if [ -f "release-assets"/*.aab ]; then
            AAB_FILE=$(ls release-assets/*.aab 2>/dev/null | head -1 | xargs -n1 basename)
            if ! grep -q "### Android" mobile-section.md; then
              echo "### Android" >> mobile-section.md
            fi
            echo "- **AAB (Release)**: [Download AAB](https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.VERSION }}/$AAB_FILE)" >> mobile-section.md
          fi
          
          # Note: iOS build is currently disabled
          # echo "### iOS" >> mobile-section.md
          # echo "- iOS builds are temporarily disabled" >> mobile-section.md
          
          # Combine notes
          # We append the mobile section to the current notes, but we don't add extra separators or text
          # The current notes already have the links and disclaimer at the bottom
          # We want to insert the mobile downloads BEFORE the links/disclaimer if possible, or just append
          
          # Simple append for now, but without extra text
          cat current-notes.md mobile-section.md > updated-notes.md
          
          # Update release
          gh release edit "v${{ steps.version.outputs.VERSION }}" --notes-file updated-notes.md
          
          echo "Release notes updated with mobile download links"